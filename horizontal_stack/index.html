<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->

<!-- 
<script src="https://d3js.org/d3.v5.js"></script>
-->

<script type="text/javascript" src="d3_v5_long.js"></script>  


<!-- Also It is C:/ not C:// -->


<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>


<script>

// https://www.d3-graph-gallery.com/graph/barplot_stacked_basicWide.html




var mark_datum = 
{"female_20" : 15,  "female_20_29" : 6,  "female_30_39" : 11,  
"female_40_49" : 19, "female_50_59" : 6, "female_60" : 12,  

"male_20" : 5,  "male_20_29" : 6,  "male_30_39" : 28, 
"male_40_49" : 6, "male_50_59" : 26, "male_60" : 19 };

var arr_data = 
[
	{
		"group": "<20",
		"Women": 15,
		"Men": 5
	},
	{
		"group": "20 - 29",
		"Women": 6,
		"Men": 6
	},
	{
		"group": "30 - 39",
		"Women": 11,
		"Men": 28
	},
	{
		"group": "40 - 49",
		"Women": 19,
		"Men": 6
  },
  {
		"group": "50 - 60",
		"Women": 6,
		"Men": 26
  },
  {
		"group": "> 60",
		"Women": 12,
		"Men": 19
	}
];

var new_arr_data = 
[
	{
		"group": "<20",
		"Women": 7,
		"Men": 23
	},
	{
		"group": "20 - 29",
		"Women": 9,
		"Men": 2
	},
	{
		"group": "30 - 39",
		"Women": 16,
		"Men": 8
	},
	{
		"group": "40 - 49",
		"Women": 28,
		"Men": 7
  },
  {
		"group": "50 - 60",
		"Women": 25,
		"Men": 9
  },
  {
		"group": "> 60",
		"Women": 19,
		"Men": 12
	}
];



var arr_totals= arr_data.map(function(q)  {return(q.Women + q.Men);})
// console.log(arr_totals);

var group_totals = d3.nest()
      .key(function(d) {
        return d.group;
      })
      .rollup(function(d) {
        return d3.sum(d, function(g) {
          return g.Women + g.Men;
        });
      })
      .entries(arr_data);

// arr_data = new_arr_data;

// var mark_subgroups = Object.keys(arr_data[0]).slice(1);


var mark_groups = d3.map(arr_data, function(d){return(d.group)}).keys();
var mark_stackedData = d3.stack().keys(["Women", "Men"])(new_arr_data);


 // ==========================================================================  
// THINGS THAT HAPPEN ONCE
// ==========================================================================  

  // dimensions
  var int_width = 520;
  var int_height = 370;
  var margin_left = 40;
  var margin_top = 0;


// append the svg to div and append group to svg
  var svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", int_width)
    .attr("height", int_height)
      .append("g")
      .attr("transform",
      "translate(" + margin_left + "," + margin_top + ")");
  
  // color
  var color = d3.scaleOrdinal()
      .domain(["Women", "Men"])
      .range(['#e41a1c','#377eb8'])

  // y scale
  var y = d3.scaleBand()
        .domain(["<20", "20 - 29", "30 - 39", "40 - 49", "50 - 60", "> 60"])
        .range([0, int_height])
        .paddingInner([0.2])
        .paddingOuter([0]);

  // y axis 
  var sg_y_axis = svg.append("g")
      .attr("transform", "translate(0," + "0" + ")")
      .call(d3.axisLeft(y));
      sg_y_axis.select(".domain").remove()
  
// ==========================================================================  
// ==========================================================================  

function fn_graph_update() {
  mark_nodes
    .attr("y", function(d) { return y(d.data.group); })
    .attr("x", function(d) { return x(d[0]);}  )
    .attr("width", function(d) { return x(d[1]) - x(d[0]); })
    .attr("height",y.bandwidth());
}


// ==========================================================================  
  
  // Add x axis -- Value scale
  // max total is 39 -- might have to subtract something to fit in width
  
  // define the x scale here....
  var max_val = d3.max(arr_totals);
  
  var x = d3.scaleLinear().domain([0, max_val]).range([0, int_width]);

// ==========================================================================  
// ==========================================================================  


// ==========================================================================  
// ==========================================================================  
// Show the bars
 var mark_nodes = 
  svg.append("g")
    .selectAll("g")
    .data(mark_stackedData)
    .enter()
      .append("g")
      .attr("class", "variable group")
      .attr("fill", function(d) { return color(d.key); })
      
      .selectAll("rect")
      .data(function(d) { return d; })
      .enter()
        .append("rect")
        .attr("y", function(d) { return y(d.data.group); })
        .attr("x", function(d) { return x(d[0]);}  )
        .attr("width", function(d) { return x(d[1]) - x(d[0]); })
        .attr("height",y.bandwidth());
 
// ==========================================================================  
// ==========================================================================  


/*

var arr_gender = ["Women", "Men"];
lcl_data = new_arr_data;


arr_gender.forEach(function(key, key_index){
  
  var bar = svg.selectAll(".bar-" + key).data(stack(lcl_data)[key_index], function(d){ return d.data.group + "-" + key; });
  
  bar
    .attr("y", function(d){ return y(d.data.group); })
    .attr("x", function(d){ return x(d[1]);})
    .attr("width", function(d){ return x(d[1]) - x(d[0]); });
  
  bar
    .enter()
    .append("rect")
      .attr("class", function(d){ return "bar bar-" + key; })
      .attr("y", function(d){ return y(d.data.group);})
      .attr("x", function(d){ return x(d[1]);})
      .attr("height", y.bandwidth())
      .attr("width", function(d){ return x(d[1]) - x(d[0]); })
      .attr("fill", function(d){ return color(key); })
}

*/










// fn_graph_update();




/*

var xx = d3.stack().keys(["Women", "Men"])(arr_data);



mark_nodes.data(xx);
fn_graph_update(mark_nodes);

mark_nodes.data(xx);
fn_graph_update();



mark_nodes.data()

var mark_stackedData = d3.stack().keys(["Women", "Men"])(new_arr_data);

*/

// fn_graph_update(mark_nodes);
// nodes.data(new_nodes);

// PLAN
// 1) another set of data with the same x scale
// 2) do the update procedure using original data set
// 3) now switch to new data 

         // nodes.data(new_nodes);
         // update();
  



/*
var totalLabels = svg.append('g').attr('class', 'totals');

totalLabels.selectAll('.total')
  .data(group_totals)
  .enter().append('text')
  .attr('class', 'total')
  .style("font-size", "10px")
  // vertical
  .attr("y", function(d) {return  y(d.key) + (y.bandwidth() / 2 ) ;})
  
  .attr("x", function(d) {return x(d.value) + 5;})
  .text(function(d) {return d.value;});
*/

</script>